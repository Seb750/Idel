<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Mini MesTransmissions - Seb</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <style>
    :root {
      --bg: #050816;
      --bg-card: #0f172a;
      --card-soft: #111827;
      --accent: #3b82f6;
      --accent-soft: rgba(59, 130, 246, 0.15);
      --accent-strong: #2563eb;
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --danger: #f97373;
      --success: #22c55e;
      --border: #1f2937;
    }

    .light {
      --bg: #f4f4f5;
      --bg-card: #ffffff;
      --card-soft: #f9fafb;
      --accent: #2563eb;
      --accent-soft: rgba(37, 99, 235, 0.12);
      --accent-strong: #1d4ed8;
      --text: #111827;
      --text-soft: #4b5563;
      --danger: #dc2626;
      --success: #16a34a;
      --border: #e5e7eb;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1f2937, #020617 55%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .app-shell {
      width: 360px;
      max-width: 100%;
      height: min(720px, 92vh);
      min-height: 640px;
      background: radial-gradient(circle at top, rgba(59, 130, 246, 0.1), var(--bg));
      border-radius: 28px;
      box-shadow:
        0 24px 60px rgba(15, 23, 42, 0.9),
        0 0 0 1px rgba(148, 163, 184, 0.2);
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.35);
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 16px 16px 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(148, 163, 184, 0.35);
      background: linear-gradient(to bottom right, rgba(15, 23, 42, 0.85), rgba(15, 23, 42, 0.3));
      backdrop-filter: blur(16px);
    }

    .app-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .app-title h1 {
      font-size: 15px;
      letter-spacing: 0.03em;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(34, 197, 94, 0.12);
      color: #bbf7d0;
      border: 1px solid rgba(34, 197, 94, 0.4);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .app-title span {
      font-size: 11px;
      color: var(--text-soft);
    }

    .theme-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-soft);
      background: rgba(15, 23, 42, 0.85);
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      cursor: pointer;
    }

    .theme-toggle span {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .theme-toggle .dot {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fbbf24, #f97316);
      box-shadow: 0 0 0 1px rgba(249, 250, 251, 0.4);
    }

    main {
      padding: 12px 12px 14px;
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(148, 163, 184, 0.5) transparent;
    }

    main::-webkit-scrollbar {
      width: 6px;
    }

    main::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.6);
      border-radius: 999px;
    }

    .nav-tabs {
      display: flex;
      gap: 6px;
      padding: 0 2px;
      margin-bottom: 12px;
    }

    .nav-tabs button {
      flex: 1;
      padding: 8px 0;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text-soft);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: all 0.16s ease-out;
      position: relative;
    }

    .nav-tabs button .icon {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.6);
    }

    .nav-tabs button.active {
      background: var(--accent-soft);
      color: var(--accent-strong);
      border-color: rgba(59, 130, 246, 0.8);
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.7),
        0 8px 20px rgba(15, 23, 42, 0.7);
      transform: translateY(-1px);
    }

    .nav-tabs button.active .icon {
      background: radial-gradient(circle at 30% 20%, #3b82f6, #1d4ed8);
      color: #eff6ff;
      border-color: rgba(191, 219, 254, 0.8);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.6);
    }

    .nav-tabs button::after {
      content: "";
      position: absolute;
      bottom: -4px;
      left: 50%;
      width: 0;
      height: 2px;
      background: var(--accent);
      border-radius: 999px;
      transition: width 0.18s ease, left 0.18s ease;
      opacity: 0;
    }

    .nav-tabs button.active::after {
      width: 18px;
      left: calc(50% - 9px);
      opacity: 1;
    }

    .badge-count {
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.2);
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: var(--text-soft);
    }

    .badge-count.is-active {
      background: rgba(59, 130, 246, 0.2);
      color: var(--accent-strong);
      border-color: rgba(59, 130, 246, 0.6);
    }

    .nav-tabs button:focus-visible {
      outline: 2px solid rgba(59, 130, 246, 0.7);
      outline-offset: 2px;
    }

    .screen {
      display: none;
      animation: fadeIn 0.18s ease-out;
    }

    .screen.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(4px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card {
      background: linear-gradient(to bottom right, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.92));
      border-radius: 20px;
      padding: 14px 14px 12px;
      box-shadow:
        0 18px 40px rgba(15, 23, 42, 0.95),
        0 0 0 1px rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.35);
      margin-bottom: 10px;
      position: relative;
      overflow: hidden;
    }

    body.light .card {
      background: linear-gradient(to bottom right, var(--bg-card), #f9fafb);
      box-shadow:
        0 12px 30px rgba(148, 163, 184, 0.35),
        0 0 0 1px rgba(226, 232, 240, 0.8);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title span.icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      background: radial-gradient(circle at 30% 20%, var(--accent), var(--accent-strong));
      color: white;
      box-shadow:
        0 0 0 1px rgba(191, 219, 254, 0.9),
        0 0 0 4px rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(191, 219, 254, 0.6);
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--text-soft);
    }

    .pill {
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px dashed rgba(148, 163, 184, 0.5);
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 1px rgba(22, 163, 74, 0.5);
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 10px;
    }

    label {
      font-size: 11px;
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    input[type="text"],
    input[type="date"],
    input[type="time"],
    input[type="number"],
    input[type="tel"],
    textarea,
    select {
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.95));
      color: var(--text);
      font-size: 12px;
      padding: 9px 10px;
      outline: none;
      box-shadow: inset 0 1px 0 rgba(15, 23, 42, 0.8);
    }

    body.light input[type="text"],
    body.light input[type="date"],
    body.light input[type="time"],
    body.light input[type="number"],
    body.light input[type="tel"],
    body.light textarea,
    body.light select {
      background: rgba(248, 250, 252, 0.98);
      color: #111827;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.9);
    }

    textarea {
      resize: vertical;
      min-height: 92px;
      max-height: 200px;
    }

    input::placeholder,
    textarea::placeholder {
      color: rgba(148, 163, 184, 0.8);
      font-size: 11px;
    }

    .subtext {
      font-size: 10px;
      color: var(--text-soft);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .subtext span {
      font-size: 12px;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
      font-size: 11px;
      color: var(--text-soft);
    }

    .checkbox-row input[type="checkbox"] {
      width: 13px;
      height: 13px;
      border-radius: 4px;
    }

    .btn-primary {
      width: 100%;
      border-radius: 999px;
      padding: 9px 12px;
      border: none;
      background: linear-gradient(to right, #2563eb, #4f46e5);
      color: white;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      box-shadow:
        0 16px 30px rgba(37, 99, 235, 0.45),
        0 0 0 1px rgba(191, 219, 254, 0.75);
      margin-top: 4px;
    }

    .btn-primary span.icon {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(219, 234, 254, 0.7);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
    }

    .btn-secondary {
      width: 100%;
      border-radius: 999px;
      padding: 7px 10px;
      border: 1px dashed rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.7);
      color: var(--text-soft);
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      margin-top: 6px;
    }

    .btn-secondary span.icon {
      font-size: 13px;
    }

    .list {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .ordo-row {
      display: grid;
      grid-template-columns: auto minmax(0, 1fr) auto;
      gap: 8px;
      align-items: start;
    }

    .ordo-row input[type="checkbox"] {
      width: 16px;
      height: 16px;
      margin-top: 2px;
    }

    .ordo-row .ordo-text {
      font-size: 11px;
      line-height: 1.4;
    }

    .ordo-row .ordo-text strong {
      font-size: 12px;
      display: block;
    }

    .icon-button {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.8);
      color: var(--text-soft);
      font-size: 10px;
      padding: 4px 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .ordo-row.done .ordo-text {
      opacity: 0.6;
      text-decoration: line-through;
    }

    .toolbar {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 110px);
      gap: 6px;
      margin-bottom: 8px;
    }

    .toolbar .row {
      display: flex;
      gap: 6px;
      align-items: center;
      grid-column: 1 / -1;
    }

    .search-field {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.75);
    }

    body.light .search-field {
      background: rgba(255, 255, 255, 0.98);
    }

    .search-field input {
      border: none;
      background: transparent;
      padding: 0;
      font-size: 11px;
      color: var(--text);
      width: 100%;
    }

    .search-field input:focus {
      outline: none;
    }

    .chip-toggle {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.7);
      color: var(--text-soft);
      font-size: 10px;
      padding: 5px 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .chip-toggle.active {
      background: rgba(59, 130, 246, 0.18);
      border-color: rgba(59, 130, 246, 0.6);
      color: var(--accent-strong);
    }

    .btn-ghost {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.8);
      color: var(--text);
      font-size: 10px;
      padding: 6px 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .empty-state {
      font-size: 11px;
      color: var(--text-soft);
      text-align: center;
      padding: 10px 0 4px;
    }

    .list-item {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 10px;
      padding: 6px 8px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      font-size: 11px;
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      gap: 4px 6px;
    }

    body.light .list-item {
      background: rgba(255, 255, 255, 0.96);
      border-color: rgba(209, 213, 219, 0.96);
    }

    .list-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 4px 8px;
      font-size: 10px;
      color: var(--text-soft);
    }

    .list-tags {
      display: inline-flex;
      gap: 4px;
      font-size: 10px;
    }

    .tag {
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.18);
      border: 1px solid rgba(148, 163, 184, 0.55);
      color: var(--text-soft);
    }

    .tag.flash {
      background: rgba(251, 191, 36, 0.14);
      color: #fde68a;
      border-color: rgba(251, 191, 36, 0.6);
    }

    .tag.type {
      background: rgba(56, 189, 248, 0.16);
      color: #a5f3fc;
      border-color: rgba(56, 189, 248, 0.6);
    }

    .tag.const {
      background: rgba(94, 234, 212, 0.1);
      color: #99f6e4;
      border-color: rgba(45, 212, 191, 0.6);
    }

    .list-actions {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      font-size: 10px;
    }

    .chip {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .chip span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #4ade80;
    }

    .chip.danger span.dot {
      background: #ef4444;
    }

    .chip.success span.dot {
      background: #22c55e;
    }

    .chip.muted span.dot {
      background: #9ca3af;
    }

    .patient-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .patient-main {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .avatar {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #3b82f6, #111827);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 13px;
      color: #e5e7eb;
      box-shadow:
        0 0 0 1px rgba(191, 219, 254, 0.8),
        0 0 0 4px rgba(37, 99, 235, 0.25);
    }

    .patient-name {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .patient-name strong {
      font-size: 13px;
    }

    .patient-name span {
      font-size: 11px;
      color: var(--text-soft);
    }

    .patient-actions {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }

    .patient-actions button {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-soft);
      font-size: 10px;
      padding: 3px 8px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    .patient-info-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.2fr);
      gap: 6px;
      margin-top: 8px;
      font-size: 11px;
    }

    .patient-info-grid span.label {
      color: var(--text-soft);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .pill-soft {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px dashed rgba(148, 163, 184, 0.6);
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill-soft span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }

    .graph-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-soft);
    }

    .graph-header strong {
      color: var(--text);
    }

    .graph-pill {
      font-size: 10px;
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px dashed rgba(148, 163, 184, 0.6);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .graph-pill span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }

    .list-mini {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 11px;
    }

    .list-mini-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 6px;
      border-radius: 8px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(55, 65, 81, 0.95);
    }

    body.light .list-mini-item {
      background: rgba(249, 250, 251, 0.98);
      border-color: rgba(209, 213, 219, 0.9);
    }

    .list-mini-item span {
      font-size: 11px;
    }

    .list-mini-item .badge-soft {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.16);
      border: 1px solid rgba(148, 163, 184, 0.65);
      color: var(--text-soft);
    }

    footer {
      margin-top: 6px;
      font-size: 10px;
      color: var(--text-soft);
      text-align: center;
      padding-bottom: 4px;
    }

    .graph-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 50;
    }

    .graph-modal-backdrop.active {
      display: flex;
    }

    .graph-modal {
      width: 100%;
      max-width: 420px;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.98), #020617);
      border-radius: 24px;
      box-shadow:
        0 24px 80px rgba(15, 23, 42, 0.95),
        0 0 0 1px rgba(30, 64, 175, 0.7);
      border: 1px solid rgba(129, 140, 248, 0.6);
      padding: 14px 14px 12px;
      position: relative;
      overflow: hidden;
    }

    .graph-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .graph-modal-header-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .graph-modal-header-title strong {
      font-size: 13px;
    }

    .graph-modal-header-title span {
      font-size: 11px;
      color: var(--text-soft);
    }

    .graph-close {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-soft);
      padding: 4px 8px;
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .graph-body {
      background: rgba(15, 23, 42, 0.96);
      border-radius: 16px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 10px 10px 8px;
      margin-bottom: 8px;
      font-size: 11px;
      min-height: 160px;
    }

    .graph-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 10px;
      color: var(--text-soft);
    }

    .graph-legend {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .legend-color {
      width: 7px;
      height: 7px;
      border-radius: 999px;
    }

    .legend-color.ta {
      background: #f97316;
    }

    .legend-color.spo2 {
      background: #22c55e;
    }

    .legend-color.temp {
      background: #3b82f6;
    }

    .legend-color.fc {
      background: #facc15;
    }

    .graph-tip {
      font-size: 10px;
      color: var(--text-soft);
    }

    #graphCanvas {
      width: 100%;
      height: 120px;
      border-radius: 12px;
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.6), rgba(15, 23, 42, 0.96));
      border: 1px dashed rgba(55, 65, 81, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(148, 163, 184, 0.7);
      font-size: 11px;
    }

    .rappel-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 8px;
    }

    .rappel-row small {
      font-size: 10px;
      color: var(--text-soft);
    }

    .memo-list {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      font-size: 11px;
    }

    .memo-item {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap: 4px 6px;
      padding: 5px 7px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.95);
    }

    body.light .memo-item {
      background: rgba(249, 250, 251, 0.98);
      border-color: rgba(209, 213, 219, 0.9);
    }

    .memo-item strong {
      font-size: 11px;
    }

    .memo-item span {
      font-size: 11px;
      color: var(--text-soft);
    }

    .memo-tags {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      font-size: 10px;
    }

    .memo-tag {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px dashed rgba(148, 163, 184, 0.7);
      color: var(--text-soft);
    }

    .pill-small {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .pill-small span.dot {
      width: 5px;
      height: 5px;
      border-radius: 999px;
      background: #22c55e;
    }

    .patient-search {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 6px;
    }

    .patient-search-row {
      display: flex;
      gap: 6px;
    }

    .patient-search-row input[type="text"] {
      flex: 1;
    }

    .patient-search-row button {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 6px 8px;
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-soft);
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .patient-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      background: rgba(15, 23, 42, 0.9);
      padding: 4px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      margin-bottom: 4px;
    }

    body.light .patient-chip {
      background: rgba(255, 255, 255, 0.96);
      border-color: rgba(209, 213, 219, 0.9);
    }

    .patient-chip span.avatar-mini {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      background: radial-gradient(circle at 30% 20%, #3b82f6, #111827);
      color: #e5e7eb;
      box-shadow: 0 0 0 1px rgba(191, 219, 254, 0.8);
    }

    .patient-chip span.name {
      font-weight: 500;
    }

    .float-debug {
      position: fixed;
      right: 12px;
      bottom: 12px;
      font-size: 10px;
      color: rgba(148, 163, 184, 0.9);
      background: rgba(15, 23, 42, 0.96);
      border-radius: 999px;
      padding: 4px 8px;
      border: 1px dashed rgba(148, 163, 184, 0.7);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .float-debug span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #4ade80;
    }

    @media (max-height: 650px) {
      .app-shell {
        transform: scale(0.94);
      }
    }

    @media (max-height: 580px) {
      .app-shell {
        transform: scale(0.9);
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 10px;
      }

      .app-shell {
        width: 100%;
        min-height: 600px;
      }

      header {
        padding: 14px 12px 8px;
      }

      .app-title h1 {
        font-size: 16px;
      }

      .app-title span {
        font-size: 12px;
      }

      main {
        padding: 12px 10px 14px;
      }

      input[type="text"],
      input[type="date"],
      input[type="time"],
      input[type="number"],
      input[type="tel"],
      textarea,
      select {
        font-size: 14px;
        padding: 11px 12px;
      }

      .btn-primary {
        font-size: 13px;
        padding: 11px 14px;
      }

      .nav-tabs button {
        font-size: 12px;
        padding: 10px 0;
      }

      .card-title {
        font-size: 14px;
      }
    }

    @media print {
      body {
        background: #ffffff;
        color: #111827;
        padding: 0;
      }

      .app-shell {
        width: 100%;
        height: auto;
        min-height: auto;
        border: none;
        box-shadow: none;
      }

      header,
      nav,
      .theme-toggle,
      .float-debug,
      .no-print {
        display: none !important;
      }

      main {
        padding: 0;
      }

      .card {
        page-break-inside: avoid;
        box-shadow: none;
        border-color: #e5e7eb;
      }
    }
  </style>
</head>
<body class="dark">
  <div class="app-shell">
    <header>
      <div class="app-title">
        <h1>
          Mini MesTransmissions
          <span class="badge">Version App iPhone ‚Äî 100% locale</span>
        </h1>
        <span>Prototype Seb ‚Äî √† bidouiller sans stress üòå</span>
      </div>
      <button class="theme-toggle" id="themeToggle" type="button">
        <span class="dot"></span>
        <span>Mode clair</span>
      </button>
    </header>

    <main>
      <nav class="nav-tabs">
        <button class="nav-item active" data-screen="transmissions">
          <span class="icon">‚ö°</span>
          <span>Trans</span>
          <span class="badge-count" data-badge="transmissions">0</span>
        </button>
        <button class="nav-item" data-screen="constantes">
          <span class="icon">üìà</span>
          <span>Const</span>
          <span class="badge-count" data-badge="constantes">0</span>
        </button>
        <button class="nav-item" data-screen="ordos">
          <span class="icon">üìÑ</span>
          <span>Ordos</span>
          <span class="badge-count" data-badge="ordos">0</span>
        </button>
        <button class="nav-item" data-screen="rappels">
          <span class="icon">‚è∞</span>
          <span>Rappels</span>
          <span class="badge-count" data-badge="rappels">0</span>
        </button>
        <button class="nav-item" data-screen="patient">
          <span class="icon">üë§</span>
          <span>Patient</span>
        </button>
      </nav>

      <!-- √âcran Transmissions -->
      <section class="screen active" id="screen-transmissions">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">‚ö°</span>
              <span>Nouvelle transmission</span>
            </div>
            <span class="card-subtitle">Non modifiable apr√®s enregistrement</span>
          </div>

          <div class="field-group">
            <div class="field-group" style="flex-direction: row; gap: 6px;">
              <div style="flex: 1;">
                <label for="transDate">Date</label>
                <input id="transDate" type="date" />
              </div>
              <div style="width: 90px;">
                <label for="transTime">Heure</label>
                <input id="transTime" type="time" />
              </div>
            </div>

            <div>
              <label for="transType">Type de transmission</label>
              <select id="transType">
                <option value="synthese">Synth√®se de prise en charge</option>
                <option value="incident">Incident / surveillance</option>
                <option value="soins">Soins techniques</option>
                <option value="education">√âducation / conseils</option>
              </select>
            </div>

            <div>
              <label for="transText">Texte de la transmission</label>
              <textarea id="transText" placeholder="√âcris ici ta transmission..."></textarea>
            </div>
          </div>

          <div class="subtext">
            <span>üí°</span>
            <span>Astuce : tu peux coller le texte g√©n√©r√© par ChatGPT, puis l‚Äôajuster.</span>
          </div>

          <div class="checkbox-row">
            <input id="transFlash" type="checkbox" />
            <label for="transFlash">Marquer comme importante (Flash Soins)</label>
          </div>

          <button class="btn-primary" id="btnSaveTrans">
            <span class="icon">üíæ</span>
            <span>Enregistrer la transmission</span>
          </button>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">‚ö°</span>
              <span>Flash Soins</span>
            </div>
            <span class="card-subtitle">Vue rapide des transmissions importantes</span>
          </div>

          <button class="btn-secondary" id="btnGenerateFlash">
            <span class="icon">‚ú®</span>
            <span>G√©n√©rer un r√©sum√© √©nergique (ChatGPT)</span>
          </button>

          <div class="list" id="flashList"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">üìã</span>
              <span>Transmissions enregistr√©es</span>
            </div>
            <button class="btn-ghost no-print" id="btnExportTrans">
              <span>‚¨áÔ∏è</span>
              <span>Exporter PDF</span>
            </button>
          </div>
          <div class="toolbar no-print">
            <div class="search-field">
              <span>üîé</span>
              <input id="transSearch" type="text" placeholder="Rechercher dans l‚Äôhistorique..." />
            </div>
            <select id="transFilterType">
              <option value="">Tous types</option>
              <option value="synthese">Synth√®se</option>
              <option value="incident">Incident</option>
              <option value="soins">Soins</option>
              <option value="education">√âducation</option>
            </select>
            <div class="row">
              <button class="chip-toggle" id="transFilterFlash">
                <span>‚ö°</span>
                <span>Flash uniquement</span>
              </button>
              <button class="chip-toggle" id="transResetFilters">
                <span>‚Ü∫</span>
                <span>R√©initialiser</span>
              </button>
            </div>
          </div>
          <div class="list" id="transList"></div>
          <div class="empty-state" id="transEmpty">Aucune transmission pour ce filtre.</div>
        </div>

        <footer>
          Tout est stock√© localement sur ton appareil (localStorage navigateur).
          Prototype Seb ‚Äî √† bidouiller sans stress üß™
        </footer>
      </section>

      <!-- √âcran Constantes -->
      <section class="screen" id="screen-constantes">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">üìà</span>
              <span>Constantes</span>
            </div>
            <span class="card-subtitle">TA, SpO‚ÇÇ, T¬∞, EVA, poids, etc.</span>
          </div>

          <div class="field-group">
            <div class="field-group" style="flex-direction: row; gap: 6px;">
              <div style="flex: 1;">
                <label for="constDate">Date</label>
                <input id="constDate" type="date" />
              </div>
              <div style="width: 90px;">
                <label for="constTime">Heure</label>
                <input id="constTime" type="time" />
              </div>
            </div>

            <div class="field-group" style="flex-direction: row; gap: 6px;">
              <div style="flex: 1;">
                <label for="taSyst">TA systolique</label>
                <input id="taSyst" type="number" placeholder="Ex : 120" />
              </div>
              <div style="flex: 1;">
                <label for="taDiast">TA diastolique</label>
                <input id="taDiast" type="number" placeholder="Ex : 70" />
              </div>
            </div>

            <div class="field-group" style="flex-direction: row; gap: 6px;">
              <div style="flex: 1;">
                <label for="spo2">SpO‚ÇÇ</label>
                <input id="spo2" type="number" placeholder="Ex : 98" />
              </div>
              <div style="flex: 1;">
                <label for="fc">FC</label>
                <input id="fc" type="number" placeholder="Ex : 72" />
              </div>
            </div>

            <div class="field-group" style="flex-direction: row; gap: 6px;">
              <div style="flex: 1;">
                <label for="temp">Temp√©rature</label>
                <input id="temp" type="number" step="0.1" placeholder="Ex : 37.2" />
              </div>
              <div style="flex: 1;">
                <label for="poids">Poids</label>
                <input id="poids" type="number" step="0.1" placeholder="Optionnel" />
              </div>
            </div>

            <div>
              <label for="constNotes">Notes / contexte</label>
              <textarea id="constNotes" placeholder="Dyspn√©e, douleur, contexte‚Ä¶"></textarea>
            </div>
          </div>

          <button class="btn-primary" id="btnSaveConst">
            <span class="icon">üíæ</span>
            <span>Enregistrer les constantes</span>
          </button>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">üìä</span>
              <span>Historique & mini-graphique</span>
            </div>
          </div>

          <div class="graph-header">
            <strong>Derni√®res constantes</strong>
            <button class="graph-pill" id="btnOpenGraph">
              <span class="dot"></span>
              <span>Afficher le graphique d√©taill√©</span>
            </button>
          </div>

          <div class="list-mini" id="constMiniList"></div>
        </div>
      </section>

      <!-- √âcran Ordos -->
      <section class="screen" id="screen-ordos">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">üìÑ</span>
              <span>Ordonnances</span>
            </div>
            <span class="card-subtitle">M√©docs, doses, horaires, dur√©e.</span>
          </div>

          <div class="field-group">
            <label for="ordoRaw">Texte brut de l‚Äôordonnance</label>
            <textarea id="ordoRaw" placeholder="Colle ici l‚Äôordonnance (ou dicte-la)‚Ä¶"></textarea>
          </div>

          <button class="btn-primary" id="btnParseOrdo">
            <span class="icon">‚ú®</span>
            <span>Structurer l‚Äôordonnance</span>
          </button>

          <div class="subtext">
            <span>üì∑</span>
            <span>Colle l‚Äôordonnance en texte brut, puis clique pour la transformer en liste de soins √† cocher.</span>
          </div>
          <div class="subtext">
            <span>üì∑</span>
            <span>Dans une v2 : photo de l‚Äôordonnance ‚Üí OCR ‚Üí structuration automatique.</span>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">üßæ</span>
              <span>Ordos structur√©es</span>
            </div>
          </div>
          <div class="list" id="ordoList"></div>
          <div class="empty-state" id="ordoEmpty">Aucun traitement structur√© pour le moment.</div>
        </div>
      </section>

      <!-- √âcran Rappels -->
      <section class="screen" id="screen-rappels">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">‚è∞</span>
              <span>Rappels en cours</span>
            </div>
          </div>

          <div class="rappel-row">
            <label for="memoText">M√©mo rapide</label>
            <input id="memoText" type="text" placeholder="Ex : appeler m√©decin √† 14h, v√©rifier pansement J3‚Ä¶" />
            <small>Simple m√©mo stock√© dans ton t√©l√©phone, rien ne part sur un serveur.</small>
          </div>

          <div class="field-group" style="flex-direction: row; gap: 6px;">
            <div style="flex: 1;">
              <label for="memoDate">Date</label>
              <input id="memoDate" type="date" />
            </div>
            <div style="width: 90px;">
              <label for="memoTime">Heure</label>
              <input id="memoTime" type="time" />
            </div>
          </div>

          <button class="btn-primary" id="btnSaveMemo">
            <span class="icon">üíæ</span>
            <span>Ajouter le m√©mo</span>
          </button>

          <div class="memo-list" id="memoList"></div>
        </div>
      </section>

      <!-- √âcran Patient -->
      <section class="screen" id="screen-patient">
        <div class="card">
          <div class="patient-header">
            <div class="patient-main">
              <div class="avatar" id="patientInitial">J</div>
              <div class="patient-name">
                <strong id="patientName">Mme L</strong>
                <span id="patientShortInfo">Patiente r√©f√©rente du tour</span>
              </div>
            </div>
            <div class="patient-actions">
              <button id="btnCopyAddress">
                <span>üìç</span>
                <span>Copier adresse</span>
              </button>
              <button id="btnOpenMaps">
                <span>üó∫Ô∏è</span>
                <span>Ouvrir Maps</span>
              </button>
              <button id="btnOpenWaze">
                <span>üöó</span>
                <span>Ouvrir Waze</span>
              </button>
            </div>
          </div>

          <div class="patient-info-grid">
            <div>
              <span class="label">T√©l√©phone</span><br />
              <span id="patientPhone">06 00 00 00 00</span>
            </div>
            <div>
              <span class="label">Adresse</span><br />
              <span id="patientAddress">12 rue de la Tour, 75000 Paris</span>
            </div>
            <div>
              <span class="label">Infos pratiques</span><br />
              <span id="patientInfos">Digicode, √©tage, ascenseur, etc.</span>
            </div>
            <div>
              <span class="label">Rythme / pansements</span><br />
              <span id="patientRhythm">Matin et soir, J1/J3/J5 pansement</span>
            </div>
          </div>

          <div style="margin-top: 10px;">
            <span class="label">R√©sum√© patient / consignes</span>
            <div style="margin-top: 4px;">
              <span class="pill-soft">
                <span class="dot"></span>
                <span id="patientSummary">Patiente ob√®se avec dyspn√©e √† l‚Äôeffort, pansement VAC jambe gauche, surveiller TA + SpO‚ÇÇ.</span>
              </span>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">üìå</span>
              <span>M√©mos patient</span>
            </div>
          </div>

          <div class="patient-search">
            <div class="patient-search-row">
              <input id="patientNotesInput" type="text" placeholder="Ex : pr√©f√®re douche le soir, fils pr√©vient si retard‚Ä¶" />
              <button id="btnAddPatientNote">
                <span>‚ûï</span>
              </button>
            </div>
          </div>

          <div class="memo-list" id="patientMemoList"></div>
        </div>
      </section>
    </main>
  </div>

  <div class="graph-modal-backdrop" id="graphModalBackdrop">
    <div class="graph-modal" id="graphModal">
      <div class="graph-modal-header">
        <div class="graph-modal-header-title">
          <strong>Graphique des constantes</strong>
          <span>Vue rapide : TA / SpO‚ÇÇ / T¬∞ / FC</span>
        </div>
        <button class="graph-close" id="graphCloseBtn">
          <span>‚úï</span>
          <span>Fermer</span>
        </button>
      </div>

      <div class="graph-body">
        <div id="graphCanvas">
          Graphique √† venir (placeholder).
        </div>
      </div>

      <div class="graph-footer">
        <div class="graph-legend">
          <div class="legend-item">
            <span class="legend-color ta"></span>
            <span>TA</span>
          </div>
          <div class="legend-item">
            <span class="legend-color spo2"></span>
            <span>SpO‚ÇÇ</span>
          </div>
          <div class="legend-item">
            <span class="legend-color temp"></span>
            <span>T¬∞</span>
          </div>
          <div class="legend-item">
            <span class="legend-color fc"></span>
            <span>FC</span>
          </div>
        </div>
        <div class="graph-tip">
          Graphique local, bas√© sur les constantes saisies.
        </div>
      </div>
    </div>
  </div>

  <div class="float-debug" id="floatDebug">
    <span class="dot"></span>
    <span id="debugText">√âcran actif : Transmissions</span>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => document.querySelectorAll(sel);

    function load(key, def) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return def;
        return JSON.parse(raw);
      } catch {
        return def;
      }
    }

    function save(key, value) {
      try {
        localStorage.setItem(key, JSON.stringify(value));
      } catch {
        console.warn("Impossible de sauvegarder dans localStorage", key);
      }
    }

    function getDateTimeFromInputs(dateEl, timeEl) {
      const dateValue = dateEl.value;
      const timeValue = timeEl.value;

      if (!dateValue && !timeValue) return new Date();

      const [year, month, day] = dateValue ? dateValue.split("-") : [];
      const [hour, minute] = timeValue ? timeValue.split(":") : [];

      const d = new Date();

      if (year && month && day) {
        d.setFullYear(Number(year), Number(month) - 1, Number(day));
      }

      if (hour && minute) {
        d.setHours(Number(hour), Number(minute), 0, 0);
      }

      return d;
    }

    function formatDateTimeLabel(dateTime) {
      if (!(dateTime instanceof Date) || isNaN(dateTime.getTime())) {
        return "";
      }

      const datePart = dateTime.toLocaleDateString("fr-FR", {
        day: "2-digit",
        month: "2-digit",
      });

      const timePart = dateTime.toLocaleTimeString("fr-FR", {
        hour: "2-digit",
        minute: "2-digit",
      });

      return `${datePart} ‚Ä¢ ${timePart}`;
    }

    function updateTabCounts() {
      const counts = {
        transmissions: load("transmissions", []).length,
        constantes: load("constantes", []).length,
        ordos: load("ordosStructured", []).length,
        rappels: load("memos", []).length,
      };

      Object.entries(counts).forEach(([key, value]) => {
        const badge = document.querySelector(`[data-badge="${key}"]`);
        if (!badge) return;
        badge.textContent = value;
        badge.style.display = value ? "inline-flex" : "none";
      });
    }

    function setupThemeToggle() {
      const toggle = $("#themeToggle");
      const body = document.body;

      function applyTheme(theme) {
        if (theme === "light") {
          body.classList.add("light");
          toggle.querySelector("span:nth-child(2)").textContent = "Mode sombre";
        } else {
          body.classList.remove("light");
          toggle.querySelector("span:nth-child(2)").textContent = "Mode clair";
        }
      }

      const savedTheme = load("theme", "dark");
      applyTheme(savedTheme);

      toggle.addEventListener("click", () => {
        const current = body.classList.contains("light") ? "light" : "dark";
        const next = current === "light" ? "dark" : "light";
        save("theme", next);
        applyTheme(next);
      });
    }

    function renderTransmissions() {
      const listEl = $("#transList");
      const flashEl = $("#flashList");
      const emptyEl = $("#transEmpty");
      const searchEl = $("#transSearch");
      const filterTypeEl = $("#transFilterType");
      const filterFlashEl = $("#transFilterFlash");
      if (!listEl || !flashEl) return;

      const transmissions = load("transmissions", []);
      listEl.innerHTML = "";
      flashEl.innerHTML = "";

      const searchValue = (searchEl?.value || "").toLowerCase().trim();
      const filterType = filterTypeEl?.value || "";
      const flashOnly = filterFlashEl?.classList.contains("active");

      const filtered = transmissions
        .slice()
        .sort((a, b) => (b.dateTime || 0) - (a.dateTime || 0))
        .filter((item) => {
          if (filterType && item.type !== filterType) return false;
          if (flashOnly && !item.isFlash) return false;
          if (!searchValue) return true;
          const haystack = [
            item.text,
            item.dateLabel,
            item.type,
          ]
            .filter(Boolean)
            .join(" ")
            .toLowerCase();
          return haystack.includes(searchValue);
        });

      filtered.forEach((item) => {
          const dateLabel =
            item.dateLabel ||
            (item.dateTime ? formatDateTimeLabel(new Date(item.dateTime)) : "");

          const tags = [];
          if (item.type === "synthese") tags.push('<span class="tag type">Synth√®se</span>');
          if (item.type === "incident") tags.push('<span class="tag type">Incident</span>');
          if (item.type === "soins") tags.push('<span class="tag type">Soins</span>');
          if (item.type === "education") tags.push('<span class="tag type">√âducation</span>');

          const main = document.createElement("div");
          main.className = "list-item";

          main.innerHTML = `
            <div>
              <div class="list-meta">
                <span>${dateLabel || "Date/heure manquantes"}</span>
                ${
                  item.type
                    ? `<span class="tag type">${item.type}</span>`
                    : `<span class="tag type">Type ?</span>`
                }
              </div>
              <div style="margin-top: 4px; font-size: 11px;">${(item.text || "")
                .replace(/\n/g, "<br>")
                .trim()}</div>
              <div class="list-tags">
                ${item.isFlash ? '<span class="tag flash">Flash</span>' : ""}
                ${tags.join("")}
              </div>
            </div>
            <div class="list-actions">
              <span class="chip ${item.isFlash ? "success" : "muted"}">
                <span class="dot"></span>
                ${item.isFlash ? "Flash" : "Normal"}
              </span>
            </div>
          `;

          listEl.appendChild(main);
        });

      transmissions
        .filter((item) => item.isFlash)
        .slice()
        .sort((a, b) => (b.dateTime || 0) - (a.dateTime || 0))
        .forEach((item) => {
          const dateLabel =
            item.dateLabel ||
            (item.dateTime ? formatDateTimeLabel(new Date(item.dateTime)) : "");
          const flashItem = document.createElement("div");
          flashItem.className = "list-mini-item";
          flashItem.innerHTML = `
            <span>${(item.text || "").slice(0, 80)}${(item.text || "").length > 80 ? "‚Ä¶" : ""}</span>
            <span class="badge-soft">${dateLabel}</span>
          `;
          flashEl.appendChild(flashItem);
        });

      if (emptyEl) {
        emptyEl.style.display = filtered.length ? "none" : "block";
      }

      updateTabCounts();
    }

    function setupTransmissions() {
      const btn = $("#btnSaveTrans");
      const dateEl = $("#transDate");
      const timeEl = $("#transTime");
      const typeEl = $("#transType");
      const textEl = $("#transText");
      const flashEl = $("#transFlash");
      const searchEl = $("#transSearch");
      const filterTypeEl = $("#transFilterType");
      const filterFlashEl = $("#transFilterFlash");
      const resetFiltersEl = $("#transResetFilters");
      const exportBtn = $("#btnExportTrans");

      if (!btn || !dateEl || !timeEl || !typeEl || !textEl || !flashEl) return;

      btn.addEventListener("click", () => {
        const transmissions = load("transmissions", []);

        const dt = getDateTimeFromInputs(dateEl, timeEl);
        const dateTimeMs = dt.getTime();
        const dateLabel = formatDateTimeLabel(dt);

        const item = {
          dateTime: dateTimeMs,
          dateLabel,
          type: typeEl.value,
          text: textEl.value.trim(),
          isFlash: flashEl.checked,
        };

        transmissions.push(item);
        save("transmissions", transmissions);
        renderTransmissions();

        textEl.value = "";
        flashEl.checked = false;
      });

      if (searchEl) {
        searchEl.addEventListener("input", renderTransmissions);
      }

      if (filterTypeEl) {
        filterTypeEl.addEventListener("change", renderTransmissions);
      }

      if (filterFlashEl) {
        filterFlashEl.addEventListener("click", () => {
          filterFlashEl.classList.toggle("active");
          renderTransmissions();
        });
      }

      if (resetFiltersEl) {
        resetFiltersEl.addEventListener("click", () => {
          if (searchEl) searchEl.value = "";
          if (filterTypeEl) filterTypeEl.value = "";
          if (filterFlashEl) filterFlashEl.classList.remove("active");
          renderTransmissions();
        });
      }

      if (exportBtn) {
        exportBtn.addEventListener("click", () => {
          window.print();
        });
      }

      renderTransmissions();
    }

    function renderConstantes() {
      const miniList = $("#constMiniList");
      if (!miniList) return;

      const data = load("constantes", []);
      miniList.innerHTML = "";

      data
        .slice()
        .sort((a, b) => (b.dateTime || 0) - (a.dateTime || 0))
        .forEach((ct) => {
          const dt = ct.dateTime ? new Date(ct.dateTime) : null;
          const dateLabel = dt ? formatDateTimeLabel(dt) : "Date/heure ?";

          const item = document.createElement("div");
          item.className = "list-mini-item";

          const chips = [];

          if (ct.taSyst && ct.taDiast) {
            chips.push(
              `<span class="pill-small"><span class="dot"></span>TA ${ct.taSyst}/${ct.taDiast}</span>`
            );
          }

          if (ct.spo2) {
            chips.push(`<span class="pill-small"><span class="dot"></span>SpO‚ÇÇ ${ct.spo2}%</span>`);
          }

          if (ct.temp) {
            chips.push(`<span class="pill-small"><span class="dot"></span>T¬∞ ${ct.temp}¬∞C</span>`);
          }

          if (ct.fc) {
            chips.push(`<span class="pill-small"><span class="dot"></span>FC ${ct.fc}</span>`);
          }

          item.innerHTML = `
            <div>
              <strong>${dateLabel}</strong>
              ${
                ct.notes
                  ? `<div style="margin-top: 2px; font-size: 10px; color: var(--text-soft);">${ct.notes}</div>`
                  : ""
              }
            </div>
            <div style="text-align: right;">
              ${chips.join("<br>")}
            </div>
          `;

          miniList.appendChild(item);
        });

      updateTabCounts();
    }

    function normalizeSpaces(value) {
      return (value || "").replace(/\s+/g, " ").trim();
    }

    function parseOrdonnance(rawText) {
      // Exemple test 1 :
      // DOLIPRANE 1 g, 1 cp matin midi soir, 7 jours, PO
      // AMOXICILLINE 500 mg 1 g√©lule 3x/j pendant 10 jours, PO
      // Exemple test 2 :
      // Lovenox 0,4 mL SC 1x/j pendant 7 jours
      // Ventoline 2 bouff√©es matin et soir si besoin, inhalation
      const lines = (rawText || "")
        .split(/\n|‚Ä¢|-/)
        .map((line) => line.trim())
        .filter(Boolean);

      return lines.map((line, index) => {
        const clean = normalizeSpaces(line);
        const doseMatch = clean.match(/\b\d+[,.]?\d*\s?(mg|g|ui|mcg|¬µg|ml|mL|%|amp|cp|g√©lule|bouff√©e)s?\b/i);
        const voieMatch = clean.match(/\b(IV|IM|SC|PO|per os|sublinguale|inhalation|patch|topique)\b/i);
        const freqMatch = clean.match(/\b(\d+x\/j|\d+\s?x\/j|matin|midi|soir|coucher|toutes?\s?\d+\s?h|q\d+h)\b/gi);
        const dureeMatch = clean.match(/\b(\d+\s?(jours?|semaines?|mois)|jusqu['‚Äô]a nouvel ordre|pendant\s+\d+\s?(jours?|semaines?|mois))\b/i);

        const medicament = clean
          .replace(doseMatch?.[0] || "", "")
          .replace(voieMatch?.[0] || "", "")
          .replace(dureeMatch?.[0] || "", "")
          .replace(freqMatch?.join(" ") || "", "")
          .replace(/,\s*/g, " ")
          .replace(/\s{2,}/g, " ")
          .trim();

        const notes = [];
        if (clean.match(/si besoin|prn/i)) notes.push("Si besoin");

        return {
          id: `${Date.now()}-${index}`,
          medicament: medicament || "Traitement",
          dose: doseMatch ? doseMatch[0] : "",
          frequence: freqMatch ? normalizeSpaces(freqMatch.join(" ")) : "",
          voie: voieMatch ? voieMatch[0] : "",
          duree: dureeMatch ? normalizeSpaces(dureeMatch[0]) : "",
          notes: notes.join(" "),
          done: false,
        };
      });
    }

    function setupConstantes() {
      const btn = $("#btnSaveConst");
      const dateEl = $("#constDate");
      const timeEl = $("#constTime");
      const taSyst = $("#taSyst");
      const taDiast = $("#taDiast");
      const spo2 = $("#spo2");
      const fc = $("#fc");
      const temp = $("#temp");
      const poids = $("#poids");
      const notes = $("#constNotes");

      if (!btn) return;

      btn.addEventListener("click", () => {
        const list = load("constantes", []);

        const dt = getDateTimeFromInputs(dateEl, timeEl);
        const dateTimeMs = dt.getTime();
        const dateLabel = formatDateTimeLabel(dt);

        const item = {
          dateTime: dateTimeMs,
          dateLabel,
          taSyst: taSyst.value.trim(),
          taDiast: taDiast.value.trim(),
          spo2: spo2.value.trim(),
          fc: fc.value.trim(),
          temp: temp.value.trim(),
          poids: poids.value.trim(),
          notes: notes.value.trim(),
        };

        list.push(item);
        save("constantes", list);
        renderConstantes();

        taSyst.value = "";
        taDiast.value = "";
        spo2.value = "";
        fc.value = "";
        temp.value = "";
        poids.value = "";
        notes.value = "";
      });

      renderConstantes();
    }

    function setupOrdos() {
      const rawEl = $("#ordoRaw");
      const btn = $("#btnParseOrdo");
      const listEl = $("#ordoList");
      const emptyEl = $("#ordoEmpty");
      if (!rawEl || !btn || !listEl) return;

      function getReadableLabel(item) {
        const parts = [
          item.dose,
          item.frequence,
          item.voie,
          item.duree,
          item.notes,
        ].filter(Boolean);
        return parts.length ? parts.join(" ‚Äì ") : "√Ä pr√©ciser";
      }

      function render() {
        const ordos = load("ordosStructured", []);
        listEl.innerHTML = "";

        ordos.forEach((o) => {
          const div = document.createElement("div");
          div.className = `list-item ordo-row ${o.done ? "done" : ""}`;

          div.innerHTML = `
            <input type="checkbox" ${o.done ? "checked" : ""} aria-label="Fait" />
            <div class="ordo-text">
              <strong>${o.medicament || "Traitement"}</strong>
              <span>${getReadableLabel(o)}</span>
            </div>
            <button class="icon-button" type="button" aria-label="Modifier">
              <span>‚úèÔ∏è</span>
              <span>√âditer</span>
            </button>
          `;

          const checkbox = div.querySelector("input[type='checkbox']");
          const editBtn = div.querySelector("button");

          checkbox.addEventListener("change", () => {
            o.done = checkbox.checked;
            save("ordosStructured", ordos);
            render();
          });

          editBtn.addEventListener("click", () => {
            const medicament = prompt("M√©dicament", o.medicament || "");
            if (medicament === null) return;
            const dose = prompt("Dose (ex : 500 mg)", o.dose || "");
            if (dose === null) return;
            const frequence = prompt("Fr√©quence (ex : 3x/j, matin/midi/soir)", o.frequence || "");
            if (frequence === null) return;
            const voie = prompt("Voie (ex : PO, IV, SC)", o.voie || "");
            if (voie === null) return;
            const duree = prompt("Dur√©e (ex : 7 jours)", o.duree || "");
            if (duree === null) return;
            const notes = prompt("Notes", o.notes || "");
            if (notes === null) return;

            Object.assign(o, {
              medicament: medicament.trim() || o.medicament,
              dose: dose.trim(),
              frequence: frequence.trim(),
              voie: voie.trim(),
              duree: duree.trim(),
              notes: notes.trim(),
            });
            save("ordosStructured", ordos);
            render();
          });

          listEl.appendChild(div);
        });

        if (emptyEl) {
          emptyEl.style.display = ordos.length ? "none" : "block";
        }

        updateTabCounts();
      }

      btn.addEventListener("click", () => {
        const raw = rawEl.value.trim();
        if (!raw) return;

        const parsed = parseOrdonnance(raw);
        const ordos = load("ordosStructured", []);
        ordos.push(...parsed);
        save("ordosStructured", ordos);

        rawEl.value = "";
        render();
      });

      render();
    }

    function setupMemos() {
      const textEl = $("#memoText");
      const dateEl = $("#memoDate");
      const timeEl = $("#memoTime");
      const btn = $("#btnSaveMemo");
      const listEl = $("#memoList");
      if (!textEl || !dateEl || !timeEl || !btn || !listEl) return;

      function render() {
        const memos = load("memos", []);
        listEl.innerHTML = "";

        memos
          .slice()
          .sort((a, b) => (a.dateTime || 0) - (b.dateTime || 0))
          .forEach((m) => {
            const dt = m.dateTime ? new Date(m.dateTime) : null;
            const dateLabel = dt ? formatDateTimeLabel(dt) : "Date/heure ?";

            const div = document.createElement("div");
            div.className = "memo-item";
            div.innerHTML = `
              <div>
                <strong>${m.text || ""}</strong>
              </div>
              <div style="text-align: right;">
                <span>${dateLabel}</span>
                <div class="memo-tags">
                  <span class="memo-tag">M√©mo</span>
                </div>
              </div>
            `;
            listEl.appendChild(div);
          });

        updateTabCounts();
      }

      btn.addEventListener("click", () => {
        const text = textEl.value.trim();
        if (!text) return;

        const dt = getDateTimeFromInputs(dateEl, timeEl);
        const dateTimeMs = dt.getTime();

        const memos = load("memos", []);
        memos.push({
          text,
          dateTime: dateTimeMs,
        });
        save("memos", memos);

        textEl.value = "";
        render();
      });

      render();
    }

    function setupPatient() {
      const addrEl = $("#patientAddress");
      const phoneEl = $("#patientPhone");
      const nameEl = $("#patientName");
      const initialEl = $("#patientInitial");

      const btnCopy = $("#btnCopyAddress");
      const btnMaps = $("#btnOpenMaps");
      const btnWaze = $("#btnOpenWaze");

      const chipName = $("#patientSummary");

      const stored = load("patient", null);
      if (stored) {
        if (stored.name) nameEl.textContent = stored.name;
        if (stored.address) addrEl.textContent = stored.address;
        if (stored.phone) phoneEl.textContent = stored.phone;
        if (stored.summary) chipName.textContent = stored.summary;
      }

      function savePatient() {
        save("patient", {
          name: nameEl.textContent,
          address: addrEl.textContent,
          phone: phoneEl.textContent,
          summary: chipName.textContent,
        });

        const name = nameEl.textContent || "";
        const firstLetter = name.trim().charAt(0).toUpperCase() || "J";
        initialEl.textContent = firstLetter;
      }

      savePatient();

      if (btnCopy) {
        btnCopy.addEventListener("click", async () => {
          try {
            await navigator.clipboard.writeText(addrEl.textContent);
            btnCopy.textContent = "Copi√© ‚úî";
            setTimeout(() => {
              btnCopy.innerHTML = "<span>üìç</span><span>Copier adresse</span>";
            }, 1500);
          } catch {
            alert("Impossible de copier l‚Äôadresse (permissions navigateur).");
          }
        });
      }

      if (btnMaps) {
        btnMaps.addEventListener("click", () => {
          const addr = addrEl.textContent || "";
          if (!addr) {
            alert("Ajoute d‚Äôabord une adresse.");
            return;
          }
          const url =
            "https://www.google.com/maps/dir/?api=1&destination=" +
            encodeURIComponent(addr) +
            "&travelmode=walking";
          window.open(url, "_blank");
        });
      }

      if (btnWaze) {
        btnWaze.addEventListener("click", () => {
          const addr = addrEl.textContent || "";
          if (!addr) {
            alert("Ajoute d‚Äôabord une adresse.");
            return;
          }
          const url =
            "https://waze.com/ul?q=" + encodeURIComponent(addr);
          window.open(url, "_blank");
        });
      }
    }

    function setupGraphModal() {
      const backdrop = $("#graphModalBackdrop");
      const modal = $("#graphModal");
      const openBtn = $("#btnOpenGraph");
      const closeBtn = $("#graphCloseBtn");

      if (!backdrop || !modal) return;

      function open() {
        backdrop.classList.add("active");
      }

      function close() {
        backdrop.classList.remove("active");
      }

      if (openBtn) openBtn.addEventListener("click", open);
      if (closeBtn) closeBtn.addEventListener("click", close);
      backdrop.addEventListener("click", (e) => {
        if (e.target === backdrop) close();
      });
    }

    function setupNavigation() {
      const navItems = $$(".nav-item");
      const screens = $$(".screen");
      const debugText = $("#debugText");

      function updateActive(screenName) {
        screens.forEach((s) => {
          const isActive = s.id === `screen-${screenName}`;
          s.classList.toggle("active", isActive);
        });

        navItems.forEach((btn) => {
          const isActive = btn.dataset.screen === screenName;
          btn.classList.toggle("active", isActive);
          const badge = btn.querySelector(".badge-count");
          if (badge) {
            badge.classList.toggle("is-active", isActive);
          }
        });

        if (debugText) {
          debugText.textContent = `√âcran actif : ${
            screenName.charAt(0).toUpperCase() + screenName.slice(1)
          }`;
        }
      }

      navItems.forEach((btn) => {
        const screenName = btn.dataset.screen;
        btn.addEventListener("click", () => {
          if (!screenName) return;
          updateActive(screenName);
        });
      });

      updateActive("transmissions");
    }

    document.addEventListener("DOMContentLoaded", () => {
      setupThemeToggle();
      setupTransmissions();
      setupConstantes();
      setupOrdos();
      setupMemos();
      setupPatient();
      setupGraphModal();
      setupNavigation();
    });
  </script>
</body>
</html>
